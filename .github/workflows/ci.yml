name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full git history for diff
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref || 'main' }} --depth=1
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Lint changed files only
        run: |
          BASE_REF="origin/${{ github.base_ref || 'main' }}"
          echo "Linting against base: $BASE_REF"
          bash ./scripts/lint_changed.sh "$BASE_REF"

  typecheck:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Type check
        run: npm run typecheck

  test_deno:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    needs: lint
    env:
      SUPABASE_URL: "${{ secrets.SUPABASE_URL }}"
      SUPABASE_ANON_KEY: "${{ secrets.SUPABASE_ANON_KEY }}"
      SUPABASE_DB_URL: "${{ secrets.SUPABASE_DB_URL }}"
      SUPABASE_SERVICE_ROLE_KEY: "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
      STRIPE_SECRET_KEY: "${{ secrets.STRIPE_SECRET_KEY }}"
      SENTRY_DSN: "${{ secrets.SENTRY_DSN }}"
    steps:
      - uses: actions/checkout@v6
      - name: "Install npm deps for Deno npm: resolution"
        run: npm ci
      - uses: denoland/setup-deno@v2
        with:
          # Pin to a Deno version that supports lockfile version 5
          deno-version: "v2.5.6"
      - name: Deno version
        run: deno --version
      - name: Cache dependencies (frozen lock)
        run: deno task deno:cache
      - name: Run reserve_gear unit tests
        run: deno test supabase/functions/reserve_gear --allow-env --allow-read --allow-import=deno.land,esm.sh,legacy.esm.sh
      - name: Run confirm_reservation unit tests
        run: deno test --quiet --allow-env --allow-read --allow-import=deno.land,esm.sh,legacy.esm.sh supabase/functions/confirm_reservation
      - name: Run cleanup_reservation_holds unit tests
        run: deno test --quiet --allow-import=deno.land,esm.sh,legacy.esm.sh supabase/functions/cleanup_reservation_holds || echo "cleanup tests skipped"
      - name: Run create_payment_intent unit tests
        run: deno test --quiet --allow-import=deno.land,esm.sh,legacy.esm.sh supabase/functions/create_payment_intent || echo "create_payment_intent tests skipped"
      - name: Run stripe_webhook unit tests
        run: deno test --quiet --allow-import=deno.land,esm.sh,legacy.esm.sh supabase/functions/stripe_webhook
      - name: Verify lockfile unchanged
        run: git diff --exit-code deno.lock
      - name: TODO Supabase RLS tests
        run: |
          echo "TODO: configure Supabase CLI db test to run supabase/tests/rls_membership.sql"

  test_db:
    # Nightly/manual only, and only if DB URL secret is present.
    # Run on Schedule, Manual Dispatch, OR Push to Main
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v6
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Run Supabase DB tests
        env:
          SUPABASE_DB_URL: "${{ secrets.SUPABASE_DB_URL }}"
        run: |
          if [[ -z "${SUPABASE_DB_URL}" ]]; then
            echo "SUPABASE_DB_URL not set; skipping db test."
            exit 0
          fi
          # Sanitize and ensure schema
          CLEAN_DB_URL=$(echo "$SUPABASE_DB_URL" | tr -d '\n' | xargs)
          if [[ "$CLEAN_DB_URL" != postgresql://* ]]; then
            CLEAN_DB_URL="postgresql://$CLEAN_DB_URL"
          fi
          supabase db test --db-url "$CLEAN_DB_URL"
      - name: Apply Supabase migrations (main only)
        env:
          SUPABASE_DB_URL: "${{ secrets.SUPABASE_DB_URL }}"
        run: |
          if [[ -z "${SUPABASE_DB_URL}" ]]; then
            echo "SUPABASE_DB_URL not set; skipping migrations."
            exit 0
          fi
          CLEAN_DB_URL=$(echo "$SUPABASE_DB_URL" | tr -d '\n' | xargs)
          if [[ "$CLEAN_DB_URL" != postgresql://* ]]; then
            CLEAN_DB_URL="postgresql://$CLEAN_DB_URL"
          fi
          supabase db push --db-url "$CLEAN_DB_URL"

  build:
    runs-on: ubuntu-latest
    needs: [typecheck, test_deno]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build

  netlify-preview:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Netlify deploy preview
        env:
          NETLIFY_AUTH_TOKEN: "${{ secrets.NETLIFY_AUTH_TOKEN }}"
          NETLIFY_SITE_ID: "${{ secrets.NETLIFY_SITE_ID }}"
        run: npx netlify deploy --dir=dist --build
