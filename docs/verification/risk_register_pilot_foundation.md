# Risk Register: Pilot Foundation

Tento registr shrnuje identifikovaná rizika u implementovaných základů formujících Kitloop Pilot infrastrukturu.

| Riziko | Dopad | Pravděpodobnost | Detekce | Mitigace / Ochrana | Doporučení | Vlastník |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Drift Scan False Positives/Negatives**<br>Regex detekce je náchylná k odhalení falešných řetězců nebo přeskočení hardcoded hodnot uvnitř dynamických templating bloků. Regulární výraz neumí AST parsování do hloubky. | Medium | High | Validní kód zablokuje CI pipeline build, vývojář si bude stěžovat. | Vývojáři použijí `// drift-scan:allow` tam, kde je detekce mylná. Pravidelné revize výjimek. | **Fix later**: Až bude více času, nasadit `eslint-plugin-i18n` s plným AST nebo lépe naladit Regex. | Tech Lead |
| **CI `origin/main` fetch breakdown**<br>Příkaz `git diff` ve skriptu `prevent-data-loss.sh` selže (např. v důsledku shallow clone Github Actions limitu). Linter neseskenuje nic. | High (Pokud by prošel DROP) | Low | Action workflow ukáže log "Failed to fetch" nebo skript spadne. | Ve file `.github/workflows/ci.yml` zajištěn flag `fetch-depth: 0` na checkout pluginu a spouští se explicit fetch pro PR base branch. | **Fix now**: Prozkoumat CI log ihned při testovacím Pull Requestu, aby checkout nevyhodil shallow chybu. | DevOps |
| **Bypass Marker Rot**<br>Extrémní zahlcení repozitáře výjimkami `-- data-loss-approved` nebo `// drift-scan:allow`, které se stanou "okoukaným standardem" a nikdo je nereviduje. | Medium | Medium | Nárůst "allow" klíčových slov v codebase na desítky. Ztráta smyslu guard systému. | Do PR templatu nebo code review přidat povinnost sepsat justification i ke komentářům. Provést bulk odstranění bypassů čtvrtletně. | **Fix later**: Přidat PR checklist template nebo týdenní summary metrik do Slacku o vzniku bypassů. | Maintainers |
| **Ztráta identity `actor_id` v triggerech (NULL actor)**<br>Postgres Security Definer hook `fn_audit_trigger` nemusí umět získat `auth.uid()`, pokud k triggeru dojde via Edge Function se service-role klíčem nebo přes Stripe Webhook interakci. | High | Medium | U desítek auditable akcí a úprav gearu chybí ID uživatele. Provozovatel nevyreklamuje ztrátu. | Trigger na to je připraven (`SET NULL`), app nespadne, ale log bude slepý. | **Fix now**: Manuálně na pilotním nasazení sledovat vliv webhooků a edge-funkcí na plnost audit záznamů. Pověnovat se Supabase Auth wrapování. | Backend Eng. |
| **RLS Leak přes Pilot Metrict View**<br>Databázové View obvykle v základu ignorují Table-level bezpečnostní pojistky (RLS). Operátor vidí cizí tržby firmám. | Critical | Low | Admin report nebo uživatel hlásí jiná čísla, než by měl mít k dispozici. | Ve schématu migrace `20260302122902_pr5_pilot_metrics_view.sql` aplikováno Postgres nastavení `security_invoker = true`. RLS dotazování probíhá korektně v kontextu usera. | **Fix now**: Důsledně ověřit dotazem po mergi s běžným účtem, jak píše Merge Checklist. Nesmí chybět na live testování. | Sec Engineer |
| **Zneužití Bypassu pro ulehčení vizuální Validace (Data-Loss)**<br>Autor narazí na nutnost refaktoringu, snaží se urychlit práci a "fiktivně" odkázat `-- data-loss-approved: ADR-9999` neexistující vazbu k dropu klíčového sloupce. | High | Low | Slidy z reportu na produkci a dropnutí struktury, která v ADR neexistovala. | Merge je pod dozorem Code-owners, Github Branch Protection zabrání merge bez peer revieweru. | **Fix now**: Ujistit se o 100% aktivaci Github Branch Protections. | Maintainers |
| **Nezměrný růst Logů (Audit Log Growth)**<br>Každá aktivita v systému a v backofficu tvoří JSON záznam, velikost volného úložiště rychle klesá. | Low (Pilot) / High (Production po roce) | High (Nevyhnutelné) | Varování Supabase na >80% databázové storage volné paměti. | Dočasné zhasínání tabulky při expiraci - Data nevyužitelná k auditu po roce smazat (`pg_cron`). | **Fix later**: Napsat delete batch úlohu do Q3 roadplanu. | Platform Eng. |
