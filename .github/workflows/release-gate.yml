name: Release Gate - Security Checks

# Path filtering strategy:
# - INCLUDE: Files that affect build output or runtime behavior
# - EXCLUDE: Documentation and markdown (docs/**, **.md)
# - NOTE: All release-critical scripts (verify_*.sh) are explicitly included
# - TRADEOFF: Scripts in scripts/** are NOT ignored to catch release script changes
# - If adding new config files, add them to paths below

on:
  push:  # Run on all branches for early feedback
    paths:
      - 'src/**'              # Application code
      - 'supabase/**'         # Database, edge functions, migrations
      - 'public/**'           # Static assets (favicon, images, _redirects)
      - 'index.html'          # HTML entry point
      - 'package.json'        # Dependencies manifest
      - 'package-lock.json'   # Lockfile (critical - prevents silent dependency changes)
      - 'deno.lock'           # Deno lockfile (affects edge function runtime)
      - 'scripts/**'          # CI/build scripts
      - 'vite.config.*'       # Build config
      - 'eslint.config.*'     # Linting config
      - 'tsconfig*.json'      # TypeScript config
      - 'tailwind.config.*'   # Styling config
      - 'postcss.config.*'    # CSS processing
      - 'netlify.toml'        # Deployment config
      - 'verify_console_guard.sh'  # Release gate script
      - '.github/workflows/**'  # All workflow files (including ci.yml)
    paths-ignore:
      - 'docs/**'    # Documentation (doesn't affect build)
      - '**.md'      # Markdown files (README, changelogs, etc.)
  pull_request:
    branches: [main]  # Block merge to main if failing
    # NOTE: No paths filter on pull_request - always run as required check
    # (paths filter on push still applies for early feedback)

concurrency:
  group: release-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-gate:
    name: Security Release Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full git history for diff

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref || 'main' }} --depth=1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'  # Match local environment (v22.20.0)
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit (supply chain)
        run: |
          # Run npm audit (informational only - doesn't fail build)
          # Upgrade to --audit-level=moderate/high when ready
          npm audit --audit-level=critical || echo "‚ö†Ô∏è  Audit found issues (non-blocking)"
        continue-on-error: true

      - name: Lint changed files only (vs main)
        run: |
          BASE_REF="origin/${{ github.base_ref || 'main' }}"
          echo "Linting against base: $BASE_REF"
          bash ./scripts/lint_changed.sh "$BASE_REF"

      - name: Run type checker
        run: npm run typecheck

      - name: Build production bundle
        run: npm run build

      - name: Verify console guard (P0 Security)
        run: |
          chmod +x ./verify_console_guard.sh
          ./verify_console_guard.sh
        
      - name: Security gate summary
        if: success()
        run: |
          echo "‚úÖ All security checks passed!"
          echo "- Linting: PASS"
          echo "- Type checking: PASS"
          echo "- Production build: PASS"
          echo "- Console guard: PASS"
          echo ""
          echo "üü¢ Release gate: GO"

      - name: Security gate failure
        if: failure()
        run: |
          echo "‚ùå Security gate FAILED!"
          echo "üî¥ Release gate: NO-GO"
          echo ""
          echo "Please fix the issues above before merging."
          exit 1
